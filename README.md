# Telegram Shop Bot (aiogram v3) — подробная инструкция
Кодировка файла: UTF-8.

Телеграм‑бот магазина с оплатой по фото, админ‑панелью в группе и поддержкой через группу.
Товары штучные: один товар можно купить только один раз.
Валюта: гривны (грн).

## Что умеет
Пользователь:
1. Каталог: город → местность → вариант → классификация.
2. Корзина, оформление заказа, отправка фото оплаты.
3. Получение товара после подтверждения.
4. Поддержка после первой покупки.

Админ:
1. Админ‑панель в группе `/admin`.
2. Мастер добавления товара (шаги с исчезающими подсказками и предпросмотром).
3. Переименование товара/города.
4. Добавление и удаление городов.
5. Управление фото вариантов.
6. История покупок пользователя.
7. Кто купил товар.
8. Список ассортимента (только доступные товары).
9. Удаление товара.
10. Заявки на подтверждение оплаты.
11. Статистика.
12. Логи.

## Быстрый старт
1. Создайте виртуальное окружение и активируйте:
```powershell
cd d:\botdone
python -m venv venv
.\venv\Scripts\activate
```
2. Установите зависимости:
```powershell
pip install aiogram aiosqlite
```
3. Заполните `.env`:
```
BOT_TOKEN=ВАШ_ТОКЕН_БОТА
ADMIN_IDS=873275713
ADMIN_GROUP_ID=-1003777622502
```
4. Запуск:
```powershell
python main.py
```

## Настройка BotFather
Рекомендуется отключить режим приватности, чтобы бот видел сообщения в группе.
В BotFather:
1. `/setprivacy`
2. Выберите бота
3. `Disable`

## Админ‑группа
1. Добавьте бота в админ‑группу.
2. Дайте права администратора.
3. В `.env` укажите `ADMIN_GROUP_ID`.

## Пользовательский сценарий
1. `/start`
2. Каталог → выбрать город → местность → вариант → классификацию.
3. Нажать на товар (если «нет в наличии» — купить нельзя).
4. Корзина → Оформить → Оплатить → отправить фото.
5. После подтверждения оплаты админом — выдача товара.

## Админ‑панель
Команда в группе: `/admin`.

Админ‑меню (inline кнопки):
- Добавить товар
- Добавить город / Удалить город
- Переименовать город / Переименовать товар
- Фото варианта
- История покупок
- Отзывы
- Кто купил товар
- Ассортимент (только доступные товары)
- Удалить товар
- Логи
- Заявки
- Статистика

### Мастер добавления товара
1. Выберите город.
2. Выберите местность.
3. Выберите вариант.
4. Выберите классификацию.
5. Отправьте фото товара.
6. Введите название.
7. Введите описание.
8. Введите цену.
9. Введите остаток: `1` или `-` (штучный товар).

После добавления:
- приходит подтверждение
- приходит предпросмотр: фото + карточка с данными товара

Подсказки шагов исчезают после выполнения (кнопки шагов не остаются).

## Поддержка
- Доступна только после первой покупки.
- Сообщения приходят в админ‑группу.
- Ответ админа реплаем на сообщение в группе — уходит пользователю в личку.
- Есть кнопки: «Закрыть чат» и «Закрыть навсегда».

## Оплата и заявки
Пользователь отправляет фото оплаты → админ подтверждает/отклоняет.
После подтверждения:
- пользователю приходит товар;
- в админ‑группу приходит сообщение о продаже (заказ, покупатель, сумма, список товаров).

## Товары и наличие
- Товар штучный.
- После покупки `stock` становится `0`, товар скрывается:
  - из каталога;
  - из ассортимента в админ‑панели.

## База данных
Файл: `data/shop.db`
Таблицы: `users`, `cities`, `areas`, `products`, `cart_items`, `orders`, `order_items`, `payments`, `reviews`, `support_threads`, `variant_photos`.

### Как проверить базу
Вариант 1: DB Browser for SQLite.
1. Открыть `data/shop.db`
2. Смотреть таблицы и данные.

Вариант 2: через консоль:
```powershell
sqlite3 data\shop.db
```
Примеры запросов:
```sql
.tables
SELECT * FROM products;
SELECT * FROM orders;
SELECT * FROM payments;
```

## Логи
Файл: `logs/bot.log`

## Частые проблемы
1. `TelegramConflictError` — запущено несколько экземпляров бота.
   Закройте все процессы `python main.py` и оставьте один.

2. Бот не видит сообщения в группе — включена приватность.
   В BotFather: `/setprivacy` → `Disable`.

3. Поддержка не открывается — у пользователя `purchases_count = 0`.

4. Кнопки не исчезают — обычно из-за нескольких запущенных экземпляров.

## Проверка кода
```powershell
python -m py_compile main.py app\config.py app\db\database.py app\handlers\user.py app\handlers\admin.py app\services\catalog.py
```
